<!doctype html>
<html>
<meta charset="utf-8">

<head>
  <title>MAV POKER</title>
  <link rel="stylesheet" href="page_style.css">
</head>

<body>
  <div style="background-color: rgb(0, 100, 177); padding: 2px; margin: -10px -10px 0px;"> <!-- header div -->
    <h1 >
      MAV POKER
    </h1>
  </div> <!-- header div -->

  <!-- content div -->
  <div style="background-color: rgb(249,246,239); margin: 10px 50px 10px; padding: 20px;"> 
    <div id="landing_page" style="display: block;">

      <div id="landing_opts">
        <p>
          <button name="new_game" onclick="onLandingNewGame()" style="padding: 15px 30px; font-size: 20px;">New
            Game</button>
        </p>
        <p>
          <button name="join_game" onclick="onLandingJoinGame()" style="padding: 15px 30px; font-size: 20px;">Join
            Game</button>
        </p>
      </div> <!-- landing_opts -->

      <div id="join_game_opts" hidden>
        <p><input id="player_name" placeholder="Enter your name" type="text"></p>
        <p><input id="join_room" placeholder="Enter room pin" type="number"></p>
        <p><button name="join_room" onclick="joinRoom()">Join Room</button></p>
      </div>
      <!--join_room_opts-->

      <div id="new_game_opts" hidden>
        <p><input id="leader_name" placeholder="Enter your name" type="text"></p>
        <p><input id="starting_balance" placeholder="Enter starting balance" type="number" min="50"></p>
        <!-- <p>Private: <input type="checkbox" id="visibility"></p> -->
        <p><button name="create_room" onclick="createRoom()">Create Room</button></p>
      </div>
    </div> <!-- landing page -->

    <div id="game_page" hidden>
      <div id="game_hud">
        <h4 id="my_info" style="font-weight: normal;"></h4>
        <h4 id="game_info" style="font-weight: normal;"></h4>
      </div>

      <hr>

      <div> <!-- game interface div -->
        <div id="cards" hidden>
          <p>
            <input type="checkbox" id="card1" onchange="onCardClick(1)" style="opacity: 0;"/>
            <label for="card1"><img src="1B.svg" id="card1_img" width="150" data-card_selected="false"/></label>

            <input type="checkbox" id="card2" onchange="onCardClick(2)" style="opacity: 0;"/>
            <label for="card2"><img src="1B.svg" id="card2_img" width="150" data-card_selected="false"/></label>

            <input type="checkbox" id="card3" onchange="onCardClick(3)" style="opacity: 0;"/>
            <label for="card3"><img src="1B.svg" id="card3_img" width="150" data-card_selected="false"/></label>

            <input type="checkbox" id="card4" onchange="onCardClick(4)" style="opacity: 0;"/>
            <label for="card4"><img src="1B.svg" id="card4_img" width="150" data-card_selected="false"/></label>

            <input type="checkbox" id="card5" onchange="onCardClick(5)" style="opacity: 0;"/>
            <label for="card5"><img src="1B.svg" id="card5_img" width="150" data-card_selected="false"/></label>
          </p>
        </div> <!-- cards -->

        <div id="pre_match" hidden>
          <p>
            <button id="start_match" onclick="onStartMatch()">Start Match</button>
            <button id="restart_match" onclick="onRestartMatch()" style="display: none;">Play Again</button>
            <p id="waiting_for_leader">Waiting for the game leader to begin the match...</p>
          </p>
        </div> <!-- pre_match -->

        <div id="game_buttons" hidden>
          <div id="betting_round_buttons" hidden>
            <p>
              <p id="my_bet"></p>
              <p id="min_bet"></p>
            </p>
            <p>
              <button id="call_button" onclick="onCall()" title="Match the minimum bet">Call</button>
              <button id="check_button" onclick="onCheck()" title="Do not place a bet">Check</button>
              <button id="fold_button" onclick="onFold()" title="Withdraw from this match">Fold</button>
              <button id="raise_toggle" onclick="onRaiseToggle()" title="Raise the minimum bet">Raise üîΩ</button>
              
              <div id="raise_interface" style="display: none; justify-content: center;">
                <button id="confirm_raise_button" onclick="onRaise(-1)" title="Confirm raise amount" style="margin-right: 30px;">Confirm</button>
                <button id="$10_raise" onclick="onRaise(10)" title="Raise min bet by $10">$10</button>
                <button id="$20_raise" onclick="onRaise(20)" title="Raise min bet by $20">$20</button>
                <button id="$50_raise" onclick="onRaise(50)" title="Raise min bet by $50">$50</button>
                <input id="raise_numberfield" placeholder="Raise by ..." type="number" min="0.01" max="2000" step="0.01" style="width: 3cm;" oninput="onRaiseAmountChange('numberfield')">
                <input id="raise_range" type="range" min="0.01" max="2000" step="0.01" value="10" style="width: 7cm;" oninput="onRaiseAmountChange('range')">
              </div> <!-- raise_interface -->
            </p>
          </div> <!-- betting_round_buttons -->

          <div id="draw_round_button" hidden>
            <p>
              <button id="swap_button" onclick="onSwap()" title="Swap the selected cards for new ones">Swap Selected</button>
              <p id="swap_tip">Click on up to 3 cards to select them...</p>
            </p>
          </div> <!-- draw_round_button -->
        </div> <!-- game_buttons -->
    </div> <!-- game interface div -->

      <p id="room_pin" style="justify-content: left;"></p>
      <h3 id="match_log">Match Log</h3>
      <div id="info_area" style="overflow-y: auto;">
      </div> <!-- info_area -->
    </div> <!-- game_page -->
  </div> <!-- content div -->

  <footer style="background-color: rgb(11,50,80); margin: 0px -10px 10px; padding: 5px; color: white">
    <p>
      <input type="button" name="back_to_main" value="Main Menu" onclick="onBackToMain()">
      <input type="button" id="rules" value="Show Rules" onclick="onRules()">
    </p>
    <div id="rules_area" style="display: none;">
      <p>
        <h4>Rounds</h4>
        <ul>
          <b>1st Betting Round (1st Round) : </b> In this round, each player is given the opportunity to give an initial bet.<br />
          <b>Draw Round (2nd Round) : </b> In this round, each player is allowed to swap out a maximum of 3 cards which are
          then replaced by random cards from the deck.<br />
          <b>Betting Round (3rd Round) : </b> In this round, each player is given the opportunity to give a second bet.<br />
          <b>Showdown Round (4th Round) : </b> In this round, all (unfolded) hands are then compared to one another,with the victor being the player with the best hand.<br />
        </ul>

        <h4>
          Hand Rankings (Strongest to Weakest):
        </h4>
        <ul>
          <b>Royal Flush : </b> A, K, Q, J, and T(10) with all the same suit. <br />
          <b>Straight Flush : </b> All cards values are in sequential order and share the same suit.<br />
          <b>Four of a Kind : </b> Four cards that have the same value.<br />
          <b>Full House : </b> Three of a Kind and a Pair.<br />
          <b>Flush : </b> All cards share the same suit but not in sequential order.<br />
          <b>Straight : </b> All cards values are in sequential order but do not share the same suit.<br />
          <b>Three of a Kind : </b> Three cards that have the same value.<br />
          <b>Two Pair : </b> Two different pairs.<br />
          <b>Pair : </b> Two cards that have the same value.<br />
          <b>High Card : </b> When a hand has none of the above ranks, the highest card plays.<br />
        </ul>
        
        <h4>Tie Breaker Rules:</h4>
        <ul>
          Two hands are only tied if their ranking is the same <b>and</b> they share all the same card values <br />
          <b>Repeating Hands :</b> These include Four of a Kind, Full House, Three of a Kind, Two Pair, and Pair. To break a tie between those hands, 
              Their repeating cards are compared. For instance, two Full Houses will compare their Three of a Kind to break the tie. 
              If they are the same, their Pairs will be compared <br />
          <b>Non Repeating hands :</b> These include Royal Flush, Straight Flush, Flush, Straight, High Card. To break a tie between those hands,
              Their highest unique cards will be compared. For instance, two High Cards will compare their highest unique card to break the tie.
              If that is the same, their next highest card will be compared and so forth.
        </ul>

        <h4>UI Symbols</h4>
        <ul>
          üëë : Is shown next to the room leader's name. The game leader is the player who started the room. <br />
          ‚¨ÖÔ∏è‚¨ÖÔ∏è : Is shown next to the name of whomever's turn it currently is. <br />
          üèÜ : Is shown in the game log, next to the name of the player(s) who won the match,
        </ul>

        If you are having an issue with the game, try refreshing the page and rejoin/ recreate your room. <b>Your current match progress will be lost.</b>
      </p>
    </div> <!-- rules_area -->
  </footer>
</body>

</html>
<script>
  
  var connection = null;
  
  var serverUrl;
  serverUrl = "ws://" + window.location.hostname + ":8881";
  
  connection = new WebSocket(serverUrl);
  connection.onopen = function (evt) {
    console.log("open");
  }

  connection.onclose = function (evt) {
    console.log("close")
  }

  var playerId
  var roomId

  var room
  var me
  var selectedCards = [0, 0, 0, 0, 0]

  var isRaisePressed = false;

  connection.onmessage = function (evt) {
    // Take the msg and turn it into a javascript object
    var msg = evt.data
    const obj = JSON.parse(msg);

    console.log("Received:")
    console.log(obj)

    if (playerId == null) {
      playerId = obj.id
      roomId = obj.id

      console.log("player ID = " + playerId)
    } else if (obj.pin == roomId) {
      room = obj
      me = obj.players[playerId]

      console.log("Me:")
      console.log(me)

      updateStats()
    } else {
      if (playerId == roomId) {
        onLandingNewGame()
        consol.log("Failed to create room. Please reload the page and try again.")
      } else {
        onLandingJoinGame()
        consol.log("Failed to join room. Check the pin, or reload the page and try again.")
      }
    }
  }

  function updateStats() {
    //UPDATE GAME HUD
    var my_info = document.getElementById("my_info")
    var match_log = document.getElementById("match_log")
    var game_info = document.getElementById("game_info")

    my_info.innerHTML = "<b>NAME: </b>" + me.name + "  <b>(id: </b>" + playerId + "<b>) <br/> BALANCE: $ </b>" + me.balance + "<br/>"
    match_log.innerHTML = "Match Log (" + room.playerCount + "/5 players)"

    game_info.innerHTML = "<b>BET POOL: $</b>" + room.match.bettingPool + "<br/><br/>"
    for (var id in room.players) {
      var bal = "$" + room.players[id].balance
      
      if (room.players[id].balance == 0 && room.match.round != "WAITING") {
        bal = "ALL OUT"
      }

      if (room.match.currentPlayerID != id || room.match.round == "WAITING") {
        game_info.innerHTML += "<b>" + room.players[id].name + ": </b>" + bal + "<br/>"
      } else {
        game_info.innerHTML += "<b>" + room.players[id].name + ": </b>" + bal + " ‚¨ÖÔ∏è‚¨ÖÔ∏è <br/>"
      }
    }

    if (me.hand.cards[0] != null) {
      var cards = me.hand.cards
      for (var i = 0; i < 5; i++) {
        var card = document.getElementById("card" + (i + 1) + "_img").src = cards[i].svg
      }
    }

    var pre_match = document.getElementById("pre_match")
    if (room.playerCount > 1 && room.match.round == "WAITING") {
      document.getElementById("waiting_for_leader").style.display="none"
      
      if (room.leaderId != me.id) {
        document.getElementById("restart_match").style.display="none"
        document.getElementById("start_match").style.display="none"
        document.getElementById("waiting_for_leader").style.display="flex"
      }
      
      pre_match.style.display = "block"
    } else {
      pre_match.style.display="none"
    }

    if (room.match.action != "") {
      var info_area = document.getElementById("info_area")

      info_area.innerHTML = room.match.action + '<br/>' + info_area.innerHTML
    }

    if (room.match.round != "WAITING") {
      console.log(room.players[room.match.currentPlayerID].name + "'s Turn (ID: " + room.match.currentPlayerID + ")")

      var cards = document.getElementById("cards")
      var game_buttons = document.getElementById("game_buttons")

      var betting_round_buttons = document.getElementById("betting_round_buttons")
      var draw_round_button = document.getElementById("draw_round_button")

      my_info.innerHTML += "<b>MY HAND: </b>" + me.hand.handType + "<br/>"

      cards.style.display = "block"
      game_buttons.style.display = "block"

      //UPDATE GAME BUTTONS

      document.getElementById("my_bet").innerHTML = "<b>My Bet: $</b>" + me.currentBet
      document.getElementById("min_bet").innerHTML = "<b>Min Bet: $</b>" + room.match.minimumBet

      document.getElementById("call_button").disabled = !(room.match.minimumBet > me.currentBet) || !(room.match.currentPlayerID == me.id) || !(me.balance != 0)
      document.getElementById("check_button").disabled = !(room.match.minimumBet <= me.currentBet || me.balance == 0) || !(room.match.currentPlayerID == me.id)
      document.getElementById("fold_button").disabled = !(me.balance != 0) || !(room.match.currentPlayerID == me.id)
      var raise_toggle = document.getElementById("raise_toggle")
      
      raise_toggle.disabled = !(me.balance != 0) || !(room.match.currentPlayerID == me.id)
      if (raise_toggle.disabled && isRaisePressed) {
        onRaiseToggle()
      }
      
      document.getElementById("$10_raise").disabled = !((me.currentBet + 10) > room.match.minimumBet)
      document.getElementById("$20_raise").disabled = !((me.currentBet + 20) > room.match.minimumBet)
      document.getElementById("$50_raise").disabled = !((me.currentBet + 50) > room.match.minimumBet)

      var raise_numberfield = document.getElementById("raise_numberfield")
      raise_numberfield.min = (room.match.minimumBet - me.currentBet) + 0.01
      raise_numberfield.max = me.balance
      raise_numberfield.value = raise_numberfield.min
      raise_numberfield.disabled = document.getElementById("raise_toggle").disabled

      var raise_range = document.getElementById("raise_range")
      raise_range.min = (room.match.minimumBet - me.currentBet) + 0.01
      raise_range.max = me.balance
      raise_range.value = raise_range.min
      raise_range.disabled = document.getElementById("raise_toggle").disabled

      document.getElementById("swap_button").disabled = !(room.match.currentPlayerID == me.id)
      if (document.getElementById("swap_button").disabled) {
        document.getElementById("swap_tip").style.display = "none"
      } else {
        document.getElementById("swap_tip").style.display = "flex"
      }

      disableCardSelectors(!(room.match.round == "DRAWING") || !(room.match.currentPlayerID == me.id))

      if (room.match.winnerID[0] != -1) {
        appointWinner(room.match.winnerID)
      } else if (room.match.round == "FIRST_BETTING" || room.match.round == "SECOND_BETTING") {
        betting_round_buttons.style.display = "block"
        draw_round_button.style.display = "none"
      } else if (room.match.round == "DRAWING") {
        betting_round_buttons.style.display = "none"
        draw_round_button.style.display = "block"
      }

      console.log("Round: " + room.match.round)
    }
  }

  function isWinner(winnerIds, playerID) {
    var isWinner = false
    for (var i = 1; i <= winnerIds[0]; i++) {
      if (playerID == winnerIds[i]) {
        isWinner = true
        break
      }
    }

    return isWinner
  }

  function appointWinner(winnerId) {
    
    var info_area = document.getElementById("info_area")
    for (var id in room.players) {
      var action = room.players[id].name + " had " + room.players[id].hand.handType + ": ["
      for (var i = 0; i < 4; i++) {
        action += room.players[id].hand.cards[i].emoji + ", "
      }
      action += room.players[id].hand.cards[4].emoji + "] "
      
      if (isWinner(winnerId, id)) {
        action = "üèÜ " + action
      }
      
      info_area.innerHTML = action + '<br/>' + info_area.innerHTML
    }

    var msg = ""
    for (var i = 1; i <= winnerId[0]; i++) {
      msg += room.players[winnerId[i]].name
      if ((winnerId[0] - i) != 0) {
        msg += " and "
      }
    }
    
    msg += " won the match with a " + room.players[winnerId[1]].hand.handType

    alert(msg)

    var cards = document.getElementById("cards")
    var game_buttons = document.getElementById("game_buttons")

    cards.style.display = "none"
    game_buttons.style.display = "none"

    if (room.leaderId == playerId) {
      document.getElementById("restart_match").style.display = "block"
      document.getElementById("start_match").style.display = "none"
      document.getElementById("pre_match").style.display = "block"
    }
  }

  function onBackToMain() {
    var landing_page = document.getElementById("landing_page")
    var game_page = document.getElementById("game_page")

    var landing_opts = document.getElementById("landing_opts")
    var new_game_opts = document.getElementById("new_game_opts")
    var join_game_opts = document.getElementById("join_game_opts")


    landing_page.style.display = "block"
    game_page.style.display = "none"

    landing_opts.style.display = "block"
    new_game_opts.style.display = "none"
    join_game_opts.style.display = "none"
  }

  function onLandingNewGame() {
    var landing_opts = document.getElementById("landing_opts")
    var new_game_opts = document.getElementById("new_game_opts")

    landing_opts.style.display = "none"
    new_game_opts.style.display = "block"
  }

  function onLandingJoinGame() {
    var landing_opts = document.getElementById("landing_opts")
    var join_game_opts = document.getElementById("join_game_opts")

    landing_opts.style.display = "none"
    join_game_opts.style.display = "block"
  }

  /* Author: Waseem Alkasbutrus
  * Last Updated: 04/2/2022
  * 
  * joinRoom(): called whenever a user clicks on the join room button
  */
  function joinRoom() {
    var joinRoomId = document.getElementById("join_room").value
    var name = document.getElementById("player_name").value

    roomId = joinRoomId

    var joinEvt = {
      event: "JOIN_ROOM",
      roomID: -1,
      playerID: playerId,
      msg: [joinRoomId, name]
    }

    connection.send(JSON.stringify(joinEvt));

    var landing_page = document.getElementById("landing_page")
    var game_page = document.getElementById("game_page")

    landing_page.style.display = "none"
    game_page.style.display = "block"
  }

  function onRules() {
    var rules = document.getElementById("rules_area")
    var show_rules = document.getElementById("rules")

    if (rules.style.display == "block") {
      rules.style.display = "none"
      show_rules.value = "Show Rules"
    } else if (rules.style.display == "none") {
      rules.style.display = "block"
      show_rules.value = "Hide Rules"
    }
  }

  function createRoom() {
    var leaderName = document.getElementById("leader_name").value
    var startingBalance = document.getElementById("starting_balance").value
    //var visibility = document.getElementById("visibility").checked

    visibility = "PRIVATE"

    // if (visibility) {
    //   visibility = "PRIVATE"
    // } else {
    //   visibility = "PUBLIC"
    // }

    var evt = {
      event: "CREATE_ROOM",
      roomID: roomId,
      playerID: playerId,
      msg: [leaderName, startingBalance, visibility]
    }

    connection.send(JSON.stringify(evt))

    var landing_page = document.getElementById("landing_page")
    var game_page = document.getElementById("game_page")
    var pre_match = document.getElementById("pre_match")

    landing_page.style.display = "none"
    pre_match.style.display = "none"
    game_page.style.display = "block"

    document.getElementById("room_pin").innerHTML = "Room Pin: [<b>" + playerId + "</b>]. Share this with friends you want to join"
  }

  function onRestartMatch() {
    if (room.playerCount > 1) {
      if (roomId == playerId) {
        var startMatchEvt = {
          event: "RESTART_MATCH",
          roomID: roomId,
          playerID: playerId,
        }

        connection.send(JSON.stringify(startMatchEvt))

        var pre_match = document.getElementById("pre_match")
        var cards = document.getElementById("cards")
        var game_buttons = document.getElementById("game_buttons")

        pre_match.style.display = "none"
        cards.style.display = "block"
        game_buttons.style.display = "block"
      } else {
        alert("Only room leader can start the match")
      }
    } else {
      alert("More players needed to start match");
    }
  }

  function onStartMatch() {
    if (room.playerCount > 1) {
      if (roomId == playerId) {
        var startMatchEvt = {
          event: "START_MATCH",
          roomID: roomId,
          playerID: playerId,
        }

        connection.send(JSON.stringify(startMatchEvt))

        var pre_match = document.getElementById("pre_match")
        var cards = document.getElementById("cards")
        var game_buttons = document.getElementById("game_buttons")

        pre_match.style.display = "none"
        cards.style.display = "block"
        game_buttons.style.display = "block"
      } else {
        alert("Only room leader can start the match")
      }
    } else {
      alert("More players needed to start match");
    }
  }

  function onRaiseAmountChange(changer) {
    var raise_range = document.getElementById("raise_range")
    var raise_numberfield = document.getElementById("raise_numberfield")

    if (changer == "range") {
      raise_numberfield.value = raise_range.value
    } else if (changer == "numberfield") {
      raise_range.value = raise_numberfield.value
    }
  }

  function onRaiseToggle() {
    var raise_toggle = document.getElementById("raise_toggle")
    var raise_interface = document.getElementById("raise_interface")

    if (isRaisePressed) {
      isRaisePressed = false
      raise_toggle.innerHTML = "Raise üîΩ"
      raise_interface.style.display = "none"
    } else {
      isRaisePressed = true
      raise_toggle.innerHTML = "Raise üîº"
      raise_interface.style.display = "flex"
    }

    raise_toggle.dataset.pressed = isRaisePressed
  }

  function onRaise(raiseBy) {
    if (room.match.currentPlayerID == playerId) {
      var textbox = document.getElementById("raise_numberfield")
      var amount = textbox.value
      
      if (raiseBy != -1) {
        amount = raiseBy
      }

      if ((amount + me.currentBet) > room.match.minimumBet) {
        var raiseEvt = {
          event: "RAISE",
          roomID: roomId,
          playerID: playerId,
          msg: [amount.toString()]
        }

        connection.send(JSON.stringify(raiseEvt))
        textbox.value = ""
      } else {
        alert("Your bet after raising must be greater than the minimum bet: $" + room.match.minimumBet)
      }
    } else {
      alert("Not your turn")
    }
  }

  function onCall() {
    if (room.match.currentPlayerID == playerId) {
      var callEvt = {
        event: "CALL",
        roomID: roomId,
        playerID: playerId,
        msg: ["NONE"]
      }

      connection.send(JSON.stringify(callEvt))
    } else {
      alert("Not your turn")
    }
  }

  function onFold() {
    if (room.match.currentPlayerID == playerId) {
      var foldEvt = {
        event: "FOLD",
        roomID: roomId,
        playerID: playerId,
        msg: ["NONE"]
      }

      connection.send(JSON.stringify(foldEvt))
    } else {
      alert("Not your turn")
    }
  }

  function onCheck() {
    if (room.match.currentPlayerID == playerId) {
      var checkEvt = {
        event: "CHECK",
        roomID: roomId,
        playerID: playerId,
        msg: ["NONE"]
      }

      connection.send(JSON.stringify(checkEvt))
    } else {
      alert("Not your turn")
    }
  }

  function onSwap() {
    if (room.match.currentPlayerID == playerId) {
      console.log(cardsClicked)
      var cardsToSwap = getSelectedCards()
      var swapEvt = {
        event: "EXCHANGE_CARDS",
        roomID: roomId,
        playerID: playerId,
        msg: cardsToSwap
      }
      
      connection.send(JSON.stringify(swapEvt))
      
      clearSelectedCards()
    } else {
      alert("Not your turn")
    }
  }

  var cardsClicked = 0
  
  function onCardClick(id) {
    card = document.getElementById('card' + id)
    cardImage = document.getElementById('card' + id + '_img')
    
    if (cardsClicked == 3 && card.checked == true) {
      card.checked = false
      cardImage.dataset.card_selected=false
    } else if (cardsClicked < 3 && card.checked == true) {
      cardsClicked++
      selectedCards[id - 1] = 1
      cardImage.dataset.card_selected="true"
    } else if (card.checked == false) {
      cardsClicked--
      selectedCards[id - 1] = 0
      cardImage.dataset.card_selected="false"
    }
    console.log(selectedCards)
  }

  function disableCardSelectors(bool) {
    for (var i = 1; i <= 5; i++) {
      document.getElementById('card' + i).disabled=bool
    }
  }

  function clearSelectedCards() {
    for (var i = 0; i < 5; i++) {
      if (selectedCards[i] == 1) {
        document.getElementById('card' + (i + 1)).click()
      }
    }
  }

  function getSelectedCards() {
    var checkedCardsCount = cardsClicked
    var checkedCards = ['' + checkedCardsCount]

    for (var i = 0; i < 5; i++) {
      if (selectedCards[i] == 1) {
        checkedCards[(cardsClicked + 1) - checkedCardsCount] = '' + i
        checkedCardsCount--;
      }
    }

    return checkedCards
  }
</script>