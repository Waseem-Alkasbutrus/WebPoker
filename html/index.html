<!doctype html>
<html>
<meta charset="utf-8">

<head>
  <title>MAV POKER</title>
  <link rel="stylesheet" href="page_style.css">
</head>

<body>
  <div style="background-color: rgb(0, 100, 177); padding: 2px; margin: -10px -10px 0px;"> <!-- header div -->
    <h1 >
      MAV POKER
    </h1>
  </div> <!-- header div -->

  <!-- content div -->
  <div style="background-color: rgb(249,246,239); margin: 10px 50px 10px; padding: 20px;"> 
    <div id="landing_page" style="display: block;">

      <div id="landing_opts">
        <p>
          <button name="new_game" onclick="onLandingNewGame()" style="padding: 15px 30px; font-size: 20px;">New
            Game</button>
        </p>
        <p>
          <button name="join_game" onclick="onLandingJoinGame()" style="padding: 15px 30px; font-size: 20px;">Join
            Game</button>
        </p>
      </div> <!-- landing_opts -->

      <div id="join_game_opts" hidden>
        <p><input id="player_name" placeholder="Enter your name" type="text"></p>
        <p><input id="join_room" placeholder="Enter room pin" type="number"></p>
        <p><button name="join_room" onclick="joinRoom()">Join Room</button></p>
      </div>
      <!--join_room_opts-->

      <div id="new_game_opts" hidden>
        <p><input id="leader_name" placeholder="Enter your name" type="text"></p>
        <p><input id="starting_balance" placeholder="Enter starting balance" type="number" min="50"></p>
        <!-- <p>Private: <input type="checkbox" id="visibility"></p> -->
        <p><button name="create_room" onclick="createRoom()">Create Room</button></p>
      </div>
    </div> <!-- landing page -->

    <div id="game_page" hidden>
      <div id="game_hud">
        <h4 id="my_name"></h4>
        <h4 id="current_balance"></h4>
        <h4 id="my_bet"></h4>
        <h4 id="bet_pool"></h4>
        <h4 id="my_hand"></h4>
        <h4 id="current_turn"></h4>
        <h4 id="all_balances"></h4>
      </div>

      <hr>

      <div> <!-- game interface div -->
        <div id="cards" hidden>
          <p>
            <input type="checkbox" id="card1" onchange="onCardClick(1)" style="opacity: 0;"/>
            <label for="card1"><img src="1B.svg" id="card1_img" width="150" data-card_selected="false"/></label>

            <input type="checkbox" id="card2" onchange="onCardClick(2)" style="opacity: 0;"/>
            <label for="card2"><img src="1B.svg" id="card2_img" width="150" data-card_selected="false"/></label>

            <input type="checkbox" id="card3" onchange="onCardClick(3)" style="opacity: 0;"/>
            <label for="card3"><img src="1B.svg" id="card3_img" width="150" data-card_selected="false"/></label>

            <input type="checkbox" id="card4" onchange="onCardClick(4)" style="opacity: 0;"/>
            <label for="card4"><img src="1B.svg" id="card4_img" width="150" data-card_selected="false"/></label>

            <input type="checkbox" id="card5" onchange="onCardClick(5)" style="opacity: 0;"/>
            <label for="card5"><img src="1B.svg" id="card5_img" width="150" data-card_selected="false"/></label>
          </p>
        </div> <!-- cards -->

        <div id="pre_match" hidden>
          <p>
            <button id="start_game" onclick="onStartMatch()">Start Match</button>
            <button id="restart_match" onclick="onRestartMatch()" style="display: none;">Play Again</button>
          </p>
        </div> <!-- pre_match -->

        <div id="game_buttons" hidden>
          <div id="betting_round_buttons" hidden>
            <p>
              <button id="call_button" onclick="onCall()" data-active="true">Call</button>
              <button id="check_button" onclick="onCheck()" data-active="true">Check</button>
              <button id="fold_button" onclick="onFold()" data-active="true">Fold</button>

              <button id="raise_button" onclick="onRaise()">Raise</button>
              <input id="raise_numberfield" placeholder="Raise by ..." type="number" min="0.01" max="2000" step="0.01" data-active="true" oninput="onRaiseAmountChange('numberfield')">
              <input id="raise_range" type="range" min="0.01" max="2000" step="0.01" value="10" data-active="true" style="width: 6cm;" oninput="onRaiseAmountChange('range')">
            </p>
          </div> <!-- betting_round_buttons -->

          <br>

          <div id="draw_round_button" hidden>
            <p>
              <button id="swap_button" onclick="onSwap()" data-active="true">Swap Selected</button>
            </p>
          </div> <!-- draw_round_button -->
        </div> <!-- game_buttons -->
    </div> <!-- game interface div -->


      <h3 id="match_log">Match Log</h3>
      <div id="info_area" style="overflow-y: auto;">
      </div> <!-- info_area -->
    </div> <!-- game_page -->
  </div> <!-- content div -->

  <div style="background-color: rgb(11,50,80); margin: 0px -10px 10px; padding: 5px;"> <!-- footer div -->

    <p>
      <input type="button" name="back_to_main" value="Main Menu" onclick="onBackToMain()">
      <input type="button" id="rules" value="Show Rules" onclick="onRules()">
    </p>
    <div id="rules_area" style="display: none;">
      <p>
        <h4>Rounds</h4>
        <ul>
          <b>1st Betting Round (1st Round) : </b> In this round, each player is given the opportunity to give an initial bet
          based on their type of hand at the start.<br />
          <b>Draw Round (2nd Round) : </b> In this round, each player is allowed to swap out a maximum of 3 cards which is
          then replaced by a random card in the deck.<br />
          <b>Betting Round (3rd Round) : </b> In this round, each player is given the opportunity to give a second bet based
          on their hand after the Draw Round.<br />
          <b>Showdown Round (4th Round) : </b> In this round, each players remaining hand is then compared to one another,
          with the victor being the player with the best hand.<br />
        </ul>
        <h4>
          Hand Rankings (Strongest to Weakest):
        </h4>
        <ul>
          <b>Royal Flush : </b> A, K, Q, J, and 10 with all the same suit. <br />
          <b>Straight Flush : </b> All cards values are in sequential order and all the same suit.<br />
          <b>Four of a Kind : </b> Four cards have the same value.<br />
          <b>Full House : </b> Three of a Kind and a Pair.<br />
          <b>Flush : </b> All cards have the same suit but not in sequential order.<br />
          <b>Straight : </b> All cards values are in sequential order but not the same suit.<br />
          <b>Three of a Kind : </b> Three cards have the same value.<br />
          <b>Two Pair : </b> Two different values of pairs.<br />
          <b>Pair : </b> Two cards have the same value.<br />
          <b>High Card : </b> When a hand has none of the above ranks, the highest card plays.<br />
        </ul>
      </p>
    </div> <!-- rules_area -->
  </div> <!-- footer div -->
</body>

</html>
<script>
  
  var connection = null;
  
  var serverUrl;
  serverUrl = "ws://" + window.location.hostname + ":8881";
  
  connection = new WebSocket(serverUrl);
  connection.onopen = function (evt) {
    console.log("open");
  }

  connection.onclose = function (evt) {
    console.log("close")
  }

  var playerId
  var roomId

  var room
  var me
  var selectedCards = [0, 0, 0, 0, 0]

  connection.onmessage = function (evt) {
    // Take the msg and turn it into a javascript object
    var msg = evt.data
    const obj = JSON.parse(msg);

    console.log("Received:")
    console.log(obj)

    if (playerId == null) {
      playerId = obj.id
      roomId = obj.id

      console.log("player ID = " + playerId)
    } else if (obj.pin == roomId) {
      room = obj
      me = obj.players[playerId]

      console.log("Me:")
      console.log(me)

      updateStats()
    }
  }

  function updateStats() {
    //UPDATE GAME HUD
    var name = document.getElementById("my_name")
    var balance = document.getElementById("current_balance")
    var match_log = document.getElementById("match_log")
    var all_balances = document.getElementById("all_balances")

    name.innerHTML = "NAME: " + me.name + "  (id: " + playerId + ")"
    balance.innerHTML = "BALANCE: $" + me.balance
    match_log.innerHTML = "Match Log (" + room.playerCount + "/5 players)"

    all_balances.innerHTML = ""
    for (var id in room.players) {
      var bal = "$" + room.players[id].balance
      
      if (room.players[id].balance == 0) {
        bal = "ALL OUT"
      }

      if (room.match.currentPlayerID != id) {
        all_balances.innerHTML += room.players[id].name + ": " + bal + "<br/>"
      } else {
        all_balances.innerHTML += " ➡️ " + room.players[id].name + ": " + bal + " ⬅️ <br/>"
      }
    }

    if (me.hand.cards[0] != null) {
      var cards = me.hand.cards
      for (var i = 0; i < 5; i++) {
        var card = document.getElementById("card" + (i + 1) + "_img").src = cards[i].svg
      }
    }

    if (room.playerCount > 1 && room.leaderId == me.id && room.match.round == "WAITING") {
      var pre_match = document.getElementById("pre_match")

      pre_match.style.display = "block"
    }

    if (room.match.action != "") {
      var info_area = document.getElementById("info_area")

      info_area.innerHTML = room.match.action + '<br/>' + info_area.innerHTML
    }

    if (room.match.round != "WAITING") {
      console.log(room.players[room.match.currentPlayerID].name + "'s Turn (ID: " + room.match.currentPlayerID + ")")

      var my_bet = document.getElementById("my_bet")
      var my_hand = document.getElementById("my_hand")
      var current_turn = document.getElementById("current_turn")
      var bet_pool = document.getElementById("bet_pool")

      var cards = document.getElementById("cards")
      var game_buttons = document.getElementById("game_buttons")

      var betting_round_buttons = document.getElementById("betting_round_buttons")
      var draw_round_button = document.getElementById("draw_round_button")

      my_bet.innerHTML = "MY BET: $" + me.currentBet
      my_hand.innerHTML = "MY HAND: " + me.hand.handType
      current_turn.innerHTML = "TURN: " + room.players[room.match.currentPlayerID].name
      bet_pool.innerHTML = "BET POOL: $" + room.match.bettingPool

      cards.style.display = "block"
      game_buttons.style.display = "block"

      //UPDATE GAME BUTTONS
      document.getElementById("call_button").disabled = !(room.match.minimumBet > me.currentBet) || !(room.match.currentPlayerID == me.id) || !(me.balance != 0)
      document.getElementById("check_button").disabled = !(room.match.minimumBet <= me.currentBet || me.balance == 0) || !(room.match.currentPlayerID == me.id)
      document.getElementById("fold_button").disabled = !(me.balance != 0) || !(room.match.currentPlayerID == me.id)
      document.getElementById("raise_button").disabled = !(me.balance != 0) || !(room.match.currentPlayerID == me.id)

      var raise_numberfield = document.getElementById("raise_numberfield")
      raise_numberfield.min = (room.match.minimumBet - me.currentBet) + 0.01
      raise_numberfield.max = me.balance
      raise_numberfield.disabled = document.getElementById("raise_button").disabled

      var raise_range = document.getElementById("raise_range")
      raise_range.min = (room.match.minimumBet - me.currentBet) + 0.01
      raise_range.max = me.balance
      raise_range.disabled = document.getElementById("raise_button").disabled

      document.getElementById("swap_button").disabled = !(room.match.currentPlayerID == me.id)

      if (room.match.winnerID[0] != -1) {
        appointWinner(room.match.winnerID)
      } else if (room.match.round == "FIRST_BETTING" || room.match.round == "SECOND_BETTING") {
        betting_round_buttons.style.display = "block"
        draw_round_button.style.display = "none"
      } else if (room.match.round == "DRAWING") {
        betting_round_buttons.style.display = "none"
        draw_round_button.style.display = "block"
      }

      console.log("Round: " + room.match.round)
    }
  }

  function isWinner(winnerIds, playerID) {
    var isWinner = false
    for (var i = 1; i <= winnerIds[0]; i++) {
      if (playerID == winnerIds[i]) {
        isWinner = true
        break
      }
    }

    return isWinner
  }

  function appointWinner(winnerId) {
    var msg = ""
    for (var i = 1; i <= winnerId[0]; i++) {
      msg += room.players[winnerId[i]].name
      if ((winnerId[0] - i) != 0) {
        msg += " and "
      }
    }
    msg += " won the match with a " + room.players[winnerId[1]].hand.handType

    alert(msg)

    var info_area = document.getElementById("info_area")
    for (var id in room.players) {
      var msg = room.players[id].name + " had: ["
      for (var i = 0; i < 4; i++) {
        msg += room.players[id].hand.cards[i].emoji + ", "
      }
      msg += room.players[id].hand.cards[4].emoji + "]"

      if (isWinner(winnerId, id)) {
        msg = "👑" + msg
      }
      
      info_area.innerHTML = msg + '<br/>' + info_area.innerHTML
    }

    var cards = document.getElementById("cards")
    var game_buttons = document.getElementById("game_buttons")

    cards.style.display = "none"
    game_buttons.style.display = "none"

    if (room.leaderId == playerId) {
      document.getElementById("restart_match").style.display = "block"
      document.getElementById("start_game").style.display = "none"
      document.getElementById("pre_match").style.display = "block"
    }
  }

  function onBackToMain() {
    var landing_page = document.getElementById("landing_page")
    var game_page = document.getElementById("game_page")

    var landing_opts = document.getElementById("landing_opts")
    var new_game_opts = document.getElementById("new_game_opts")
    var join_game_opts = document.getElementById("join_game_opts")


    landing_page.style.display = "block"
    game_page.style.display = "none"

    landing_opts.style.display = "block"
    new_game_opts.style.display = "none"
    join_game_opts.style.display = "none"
  }

  function onLandingNewGame() {
    var landing_opts = document.getElementById("landing_opts")
    var new_game_opts = document.getElementById("new_game_opts")

    landing_opts.style.display = "none"
    new_game_opts.style.display = "block"
  }

  function onLandingJoinGame() {
    var landing_opts = document.getElementById("landing_opts")
    var join_game_opts = document.getElementById("join_game_opts")

    landing_opts.style.display = "none"
    join_game_opts.style.display = "block"
  }

  /* Author: Waseem Alkasbutrus
  * Last Updated: 04/2/2022
  * 
  * joinRoom(): called whenever a user clicks on the join room button
  */
  function joinRoom() {
    var joinRoomId = document.getElementById("join_room").value
    var name = document.getElementById("player_name").value

    roomId = joinRoomId

    var joinEvt = {
      event: "JOIN_ROOM",
      roomID: -1,
      playerID: playerId,
      msg: [joinRoomId, name]
    }

    connection.send(JSON.stringify(joinEvt));

    var landing_page = document.getElementById("landing_page")
    var game_page = document.getElementById("game_page")

    landing_page.style.display = "none"
    game_page.style.display = "block"
  }

  function onRules() {
    var rules = document.getElementById("rules_area")
    var show_rules = document.getElementById("rules")

    if (rules.style.display == "block") {
      rules.style.display = "none"
      show_rules.value = "Show Rules"
    } else if (rules.style.display == "none") {
      rules.style.display = "block"
      show_rules.value = "Hide Rules"
    }
  }

  function createRoom() {
    var leaderName = document.getElementById("leader_name").value
    var startingBalance = document.getElementById("starting_balance").value
    //var visibility = document.getElementById("visibility").checked

    visibility = "PRIVATE"

    // if (visibility) {
    //   visibility = "PRIVATE"
    // } else {
    //   visibility = "PUBLIC"
    // }

    var evt = {
      event: "CREATE_ROOM",
      roomID: roomId,
      playerID: playerId,
      msg: [leaderName, startingBalance, visibility]
    }

    connection.send(JSON.stringify(evt))

    var landing_page = document.getElementById("landing_page")
    var game_page = document.getElementById("game_page")
    var pre_match = document.getElementById("pre_match")

    landing_page.style.display = "none"
    pre_match.style.display = "none"
    game_page.style.display = "block"
  }

  function onRestartMatch() {
    if (room.playerCount > 1) {
      if (roomId == playerId) {
        var startMatchEvt = {
          event: "RESTART_MATCH",
          roomID: roomId,
          playerID: playerId,
        }

        connection.send(JSON.stringify(startMatchEvt))

        var pre_match = document.getElementById("pre_match")
        var cards = document.getElementById("cards")
        var game_buttons = document.getElementById("game_buttons")

        pre_match.style.display = "none"
        cards.style.display = "block"
        game_buttons.style.display = "block"
      } else {
        alert("Only room leader can start the match")
      }
    } else {
      alert("More players needed to start match");
    }
  }

  function onStartMatch() {
    if (room.playerCount > 1) {
      if (roomId == playerId) {
        var startMatchEvt = {
          event: "START_MATCH",
          roomID: roomId,
          playerID: playerId,
        }

        connection.send(JSON.stringify(startMatchEvt))

        var pre_match = document.getElementById("pre_match")
        var cards = document.getElementById("cards")
        var game_buttons = document.getElementById("game_buttons")

        pre_match.style.display = "none"
        cards.style.display = "block"
        game_buttons.style.display = "block"
      } else {
        alert("Only room leader can start the match")
      }
    } else {
      alert("More players needed to start match");
    }
  }

  function onRaiseAmountChange(changer) {
    var raise_range = document.getElementById("raise_range")
    var raise_numberfield = document.getElementById("raise_numberfield")

    if (changer == "range") {
      raise_numberfield.value = raise_range.value
    } else if (changer == "numberfield") {
      raise_range.value = raise_numberfield.value
    }
  }

  function onRaise() {
    if (room.match.currentPlayerID == playerId) {
      var textbox = document.getElementById("raise_numberfield")

      var amount = textbox.value
      if ((amount + me.currentBet) > room.match.minimumBet) {
        var raiseEvt = {
          event: "RAISE",
          roomID: roomId,
          playerID: playerId,
          msg: [amount]
        }

        connection.send(JSON.stringify(raiseEvt))
        textbox.value = ""
      } else {
        alert("Please specify a value to raise")
      }
    } else {
      alert("Not your turn")
    }
  }

  function onCall() {
    if (room.match.currentPlayerID == playerId) {
      var callEvt = {
        event: "CALL",
        roomID: roomId,
        playerID: playerId,
        msg: ["NONE"]
      }

      connection.send(JSON.stringify(callEvt))
    } else {
      alert("Not your turn")
    }
  }

  function onFold() {
    if (room.match.currentPlayerID == playerId) {
      var foldEvt = {
        event: "FOLD",
        roomID: roomId,
        playerID: playerId,
        msg: ["NONE"]
      }

      connection.send(JSON.stringify(foldEvt))
    } else {
      alert("Not your turn")
    }
  }

  function onCheck() {
    if (room.match.currentPlayerID == playerId) {
      var checkEvt = {
        event: "CHECK",
        roomID: roomId,
        playerID: playerId,
        msg: ["NONE"]
      }

      connection.send(JSON.stringify(checkEvt))
    } else {
      alert("Not your turn")
    }
  }

  function onSwap() {
    if (room.match.currentPlayerID == playerId) {
      console.log(cardsClicked)
      var cardsToSwap = getSelectedCards()
      var swapEvt = {
        event: "EXCHANGE_CARDS",
        roomID: roomId,
        playerID: playerId,
        msg: cardsToSwap
      }
      
      connection.send(JSON.stringify(swapEvt))
      
      clearSelectedCards()
    } else {
      alert("Not your turn")
    }
  }

  var cardsClicked = 0
  
  function onCardClick(id) {
    card = document.getElementById('card' + id)
    cardImage = document.getElementById('card' + id + '_img')
    
    if (cardsClicked == 3 && card.checked == true) {
      card.checked = false
      cardImage.dataset.card_selected=false
    } else if (cardsClicked < 3 && card.checked == true) {
      cardsClicked++
      selectedCards[id - 1] = 1
      cardImage.dataset.card_selected="true"
    } else if (card.checked == false) {
      cardsClicked--
      selectedCards[id - 1] = 0
      cardImage.dataset.card_selected="false"
    }
    console.log(selectedCards)
  }

  function clearSelectedCards() {
    cardsClicked = 0;

    for (var i = 0; i < 5; i++) {
      if (selectedCards[i] == 1) {
        document.getElementById('card' + (i + 1)).click()
      }
    }
  }

  function getSelectedCards() {
    var checkedCardsCount = cardsClicked
    var checkedCards = ['' + checkedCardsCount]

    for (var i = 0; i < 5; i++) {
      if (selectedCards[i] == 1) {
        checkedCards[(cardsClicked + 1) - checkedCardsCount] = '' + i
        checkedCardsCount--;
      }
    }

    return checkedCards
  }
</script>